<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipClock Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Futuristic Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Added Roboto Mono and Major Mono Display for digit options -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@400;600&family=Inter:wght@400;600;700&family=Roboto+Mono:wght@700&family=Major+Mono+Display&display=swap" rel="stylesheet">
    
    <style>
        /* Define CSS variables for customization */
        :root {
            --primary-color: #4F46E5; /* Default to Indigo for a cleaner start */
            --digit-font-family: 'Orbitron', sans-serif; /* New variable for digits */
        }
        
        /* Apply base font and color */
        body {
            font-family: 'Rajdhani', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #F9FAFB;
        }
        
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Dynamic primary color applications */
        .text-primary-color {
            color: var(--primary-color);
        }
        .border-primary-color {
            border-color: var(--primary-color);
        }
        /* Active nav button background and border color */
        .nav-button-active {
            background-color: var(--primary-color); 
            color: #111;
            border-width: 1px;
            border-style: solid;
        }
        
        /* * ==============================================
         * === FOCUS MODE STYLES (Hide all distracting elements) ===
         * ==============================================
         */
        body.fullscreen-focus > header,
        body.fullscreen-focus #pomodoro-view > .text-center, /* Pomodoro Title and status */
        body.fullscreen-focus #pomodoro-settings,
        body.fullscreen-focus #pomodoro-controls-container,
        body.fullscreen-focus #alarm-sound {
            display: none !important;
        }
        /* Scale the clock container up significantly in focus mode */
        body.fullscreen-focus #pomodoro-view .inline-flex {
            transform: scale(1.5);
            /* Remove shadows/padding in focus mode for maximal simplicity */
            box-shadow: none !important;
            padding: 0 !important; 
            background: none !important;
        }
        
        /* * ==============================================
         * === SPLIT-FLAP ANIMATION STYLES ===
         * ==============================================
         */

        .digit-container {
            width: 100px;
            height: 140px;
            perspective: 1000px;
            transform: scale(0.8);
        }
        
        @media (min-width: 640px) {
            .digit-container {
                transform: scale(0.9);
            }
        }

        @media (min-width: 1024px) {
            .digit-container {
                transform: scale(1);
            }
        }

        .digit-half {
            position: absolute;
            width: 100%;
            height: 70px;
            overflow: hidden;
            background: #111;
            border: 1px solid #333;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .digit-half-content {
            font-size: 110px;
            font-weight: 700;
            color: #ffffff;
            font-family: var(--digit-font-family); /* Use variable for digits */
            user-select: none;
            line-height: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .static-top {
            top: 0;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #333;
        }

        .static-top .digit-half-content {
            margin-top: 0;
        }

        .static-bottom {
            bottom: 0;
            border-radius: 0 0 8px 8px;
            border-top: 1px solid #333;
            align-items: flex-end;
        }

        .static-bottom .digit-half-content {
            margin-top: -70px;
        }

        .flap {
            position: absolute;
            top: 0;
            width: 100%;
            height: 70px;
            transform-style: preserve-3d;
            transform-origin: bottom;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .flipping .flap {
            transform: rotateX(-180deg);
        }

        .flap-face {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            backface-visibility: hidden;
            background: #111;
            border: 1px solid #333;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .flap-face-content {
            font-size: 110px;
            font-weight: 700;
            color: #ffffff;
            font-family: var(--digit-font-family); /* Use variable for digits */
            user-select: none;
            line-height: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flap-front {
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .flap-front .flap-face-content {
            margin-top: 0;
        }

        .flap-back {
            transform: rotateX(180deg);
            border-radius: 0 0 8px 8px;
            border-top: 1px solid #333;
            align-items: flex-end;
        }

        .flap-back .flap-face-content {
            margin-top: -70px;
        }
        
        /* Separator dots */
        .separator {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .separator-dot {
            width: 0.75rem;
            height: 0.75rem;
            background-color: #aaa;
            border-radius: 9999px;
            box-shadow: none;
        }
        
        /* Custom input style */
        .dark-input {
            background-color: #111;
            color: white;
            border: 1px solid #333;
            border-radius: 0.5rem;
            text-align: center;
            padding: 0.75rem 1rem;
            font-family: inherit;
        }
        .dark-input:focus {
            outline: none;
            border-color: white;
        }

        /* Futuristic Button Styles */
        .btn {
            font-family: 'Orbitron', sans-serif;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background-color: var(--primary-color); /* Use variable */
            color: #111;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: #1F2937;
            color: #F9FAFB;
            border: 1px solid #374151;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        
        .btn-danger {
            background-color: #EF4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #DC2626;
        }

        /* Style the color picker */
        .color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 48px;
            height: 48px;
            background-color: transparent;
            border: 1px solid #333;
            padding: 0;
            border-radius: 8px;
            cursor: pointer;
        }
        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 7px;
        }
        .color-picker::-moz-color-swatch {
            border: none;
            border-radius: 7px;
        }

    </style>
</head>
<body class="min-h-screen bg-black flex items-center justify-center p-4 sm:p-8">

    <div class="max-w-5xl w-full">

        <!-- Header and Navigation -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-12">
            <h1 class="text-3xl font-bold tracking-wider mb-6 sm:mb-0 font-orbitron text-primary-color" id="app-title">FLIPCLOCK PRO</h1>
            <nav class="flex gap-2 p-1 bg-gray-900 rounded-full border border-gray-700">
                <button id="nav-clock" class="nav-button px-6 py-2 rounded-full text-gray-300 hover:bg-gray-700 hover:text-white transition-colors font-orbitron text-sm">CLOCK</button>
                <button id="nav-pomodoro" class="nav-button px-6 py-2 rounded-full text-gray-300 hover:bg-gray-700 hover:text-white transition-colors font-orbitron text-sm">POMODORO</button>
                <button id="nav-alarm" class="nav-button px-6 py-2 rounded-full text-gray-300 hover:bg-gray-700 hover:text-white transition-colors font-orbitron text-sm">ALARM</button>
                
                <!-- SETTINGS BUTTON -->
                <button id="nav-settings" class="nav-button px-3 py-2 rounded-full text-gray-300 hover:bg-gray-700 hover:text-white transition-colors font-orbitron text-sm">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.502 1.524.502.507 0 1.006-.18 1.523-.502z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </nav>
        </header>

        <!-- ==============================================
             === MAIN CONTENT AREA ===
             ============================================== -->
        <main>

            <!-- 
             * ==============================================
             * === CLOCK VIEW ===
             * ==============================================
            -->
            <div id="clock-view" class="app-view" hidden>
                <div class="flex justify-center mb-16">
                    <div class="inline-flex gap-0 sm:gap-4 p-4 sm:p-12 bg-gray-950 rounded-3xl shadow-2xl">
                        <!-- Hours -->
                        <div class="flex gap-1 sm:gap-3">
                            <div id="clock-hr-tens" class="digit-container"></div>
                            <div id="clock-hr-ones" class="digit-container"></div>
                        </div>
                        
                        <div class="separator">
                            <div class="separator-dot"></div>
                            <div class="separator-dot"></div>
                        </div>
                        
                        <!-- Minutes -->
                        <div class="flex gap-1 sm:gap-3">
                            <div id="clock-min-tens" class="digit-container"></div>
                            <div id="clock-min-ones" class="digit-container"></div>
                        </div>
                        
                        <div class="separator">
                            <div class="separator-dot"></div>
                            <div class="separator-dot"></div>
                        </div>
                        
                        <!-- Seconds -->
                        <div class="flex gap-1 sm:gap-3">
                            <div id="clock-sec-tens" class="digit-container"></div>
                            <div id="clock-sec-ones" class="digit-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 
             * ==============================================
             * === POMODORO VIEW ===
             * ==============================================
            -->
            <div id="pomodoro-view" class="app-view" hidden>
                <!-- Title -->
                <div class="text-center mb-12">
                    <h1 id="pomodoro-title" class="text-5xl font-bold mb-2 tracking-wider font-orbitron">POMODORO</h1>
                    <p id="pomodoro-status" class="text-gray-400 text-lg">Focus Time</p>
                </div>

                <!-- Split-Flap Display -->
                <div class="flex justify-center mb-16">
                    <div class="inline-flex gap-0 sm:gap-8 p-4 sm:p-12 bg-gray-950 rounded-3xl shadow-2xl">
                        <!-- Minutes -->
                        <div class="flex gap-1 sm:gap-3">
                            <div id="pomo-min-tens" class="digit-container"></div>
                            <div id="pomo-min-ones" class="digit-container"></div>
                        </div>
                        
                        <div class="separator">
                            <div class="separator-dot"></div>
                            <div class="separator-dot"></div>
                        </div>
                        
                        <!-- Seconds -->
                        <div class="flex gap-1 sm:gap-3">
                            <div id="pomo-sec-tens" class="digit-container"></div>
                            <div id="pomo-sec-ones" class="digit-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Timer Settings -->
                <div id="pomodoro-settings" class="flex flex-col items-center gap-12">
                    <div class="flex justify-center gap-8">
                        <div class="flex flex-col items-center">
                            <label class="text-gray-400 mb-2 text-sm uppercase tracking-wide">Focus (min)</label>
                            <input
                                id="focus-time-input"
                                type="number"
                                value="25"
                                class="w-24 px-4 py-3 dark-input"
                                min="1"
                            />
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-gray-400 mb-2 text-sm uppercase tracking-wide">Break (min)</label>
                            <input
                                id="break-time-input"
                                type="number"
                                value="5"
                                class="w-24 px-4 py-3 dark-input"
                                min="1"
                            />
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div id="pomodoro-controls-container" class="flex flex-col items-center gap-4 mt-12">
                    <!-- Row 1: Start/Pause, Reset, and Focus Button -->
                    <div class="flex justify-center gap-6">
                        <button
                            id="start-pause-btn"
                            class="btn btn-primary"
                        >
                            Start
                        </button>
                        <button
                            id="reset-btn"
                            class="btn btn-secondary"
                        >
                            Reset
                        </button>
                        <button
                            id="focus-mode-btn"
                            class="btn btn-secondary"
                        >
                            Focus Mode
                        </button>
                    </div>
                    <!-- Row 2: Continue (hidden by default) -->
                    <div class="flex justify-center">
                        <button
                            id="continue-btn"
                            class="btn btn-primary"
                            hidden
                        >
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- 
             * ==============================================
             * === ALARM VIEW ===
             * ==============================================
            -->
            <div id="alarm-view" class="app-view text-center" hidden>
                <h1 class="text-5xl font-bold mb-12 tracking-wider font-orbitron">SET ALARM</h1>
                
                <div class="flex justify-center gap-4 mb-8">
                    <input id="alarm-time-input" type="time" class="dark-input text-2xl w-48">
                </div>
                
                <div class="flex justify-center gap-6 mb-8">
                     <button
                        id="set-alarm-btn"
                        class="btn btn-primary"
                    >
                        Set Alarm
                    </button>
                    <button
                        id="clear-alarm-btn"
                        class="btn btn-secondary"
                    >
                        Clear Alarm
                    </button>
                </div>
                
                <div id="alarm-stop-controls" class="flex justify-center gap-6 mb-8" hidden>
                    <button
                        id="stop-alarm-btn"
                        class="btn btn-danger"
                    >
                        Stop Alarm
                    </button>
                </div>
                
                <p id="alarm-status-message" class="text-gray-400 text-lg h-6"></p>

            </div>

            <!-- 
             * ==============================================
             * === SETTINGS VIEW ===
             * ==============================================
            -->
            <div id="settings-view" class="app-view text-center" hidden>
                <div class="flex justify-center">
                    <div class="w-full max-w-lg bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg text-left">
                        <h1 class="text-3xl font-bold mb-6 font-orbitron text-primary-color border-b border-gray-700 pb-3">Theme Settings</h1>
                        
                        <!-- Font Selector: Body Text -->
                        <div class="flex justify-between items-center mb-5">
                            <label for="font-select" class="text-gray-400 uppercase text-sm tracking-wider">Body Text Font</label>
                            <select id="font-select" class="dark-input py-2 px-3 w-36">
                                <option value="Rajdhani">Rajdhani</option>
                                <option value="Inter">Inter</option>
                                <option value="Monospace">Monospace</option>
                            </select>
                        </div>
                        
                        <!-- Font Selector: Clock Digits -->
                        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-5">
                            <label for="digit-font-select" class="text-gray-400 uppercase text-sm tracking-wider">Clock Digits Font</label>
                            <select id="digit-font-select" class="dark-input py-2 px-3 w-36">
                                <option value="Orbitron">Orbitron (Futuristic)</option>
                                <option value="Roboto Mono">Roboto Mono (Tech)</option>
                                <option value="Major Mono Display">Major Mono (Minimal)</option>
                            </select>
                        </div>

                        <!-- Color Picker -->
                        <div class="flex justify-between items-center mb-6 pt-5">
                            <label for="accent-color-picker" class="text-gray-400 uppercase text-sm tracking-wider">Accent Color</label>
                            <input type="color" id="accent-color-picker" class="color-picker" value="#4F46E5">
                        </div>

                        <!-- Theme Presets -->
                        <div class="border-t border-gray-700 pt-4">
                            <label class="text-gray-400 uppercase text-sm tracking-wider block mb-2 text-center">Color Presets</label>
                            <div class="flex gap-2 justify-center">
                                <button data-color="#4F46E5" class="theme-preset-btn w-10 h-10 rounded-full border-2 border-gray-700 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500 hover:ring-offset-gray-900 transition-all" style="background-color: #4F46E5;" title="Indigo"></button>
                                <button data-color="#10B981" class="theme-preset-btn w-10 h-10 rounded-full border-2 border-gray-700 hover:ring-2 hover:ring-offset-2 hover:ring-emerald-500 hover:ring-offset-gray-900 transition-all" style="background-color: #10B981;" title="Emerald"></button>
                                <button data-color="#F9FAFB" class="theme-preset-btn w-10 h-10 rounded-full border-2 border-gray-700 hover:ring-2 hover:ring-offset-2 hover:ring-white hover:ring-offset-gray-900 transition-all" style="background-color: #F9FAFB;" title="White"></button>
                                <button data-color="#FBBF24" class="theme-preset-btn w-10 h-10 rounded-full border-2 border-gray-700 hover:ring-2 hover:ring-offset-2 hover:ring-amber-500 hover:ring-offset-gray-900 transition-all" style="background-color: #FBBF24;" title="Amber"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </main>

        <!-- Hidden audio element -->
        <audio id="alarm-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ==============================================
            // === GLOBAL STATE & DOM ELEMENTS ===
            // ==============================================
            
            let globalState = {
                activeView: 'pomodoro',
                pomodoro: {
                    focusTime: 25, // minutes
                    breakTime: 5,  // minutes
                    timeLeft: 25 * 60, // seconds
                    isRunning: false,
                    isBreak: false,
                    isAlarmPlaying: false,
                    intervalId: null
                },
                alarm: {
                    setTime: null, // e.g., "14:30"
                    isAlarmPlaying: false,
                    checkIntervalId: null
                },
                clock: {
                    intervalId: null
                },
                theme: {
                    font: 'Rajdhani',
                    digitFont: 'Orbitron', // New state for digit font
                    primaryColor: '#4F46E5' // Default set to Indigo
                }
            };
            
            // --- General Elements ---
            const root = document.documentElement;
            const body = document.body;
            const audio = document.getElementById('alarm-sound');
            
            // --- Navigation Elements ---
            const navButtons = {
                clock: document.getElementById('nav-clock'),
                pomodoro: document.getElementById('nav-pomodoro'),
                alarm: document.getElementById('nav-alarm'),
                settings: document.getElementById('nav-settings') 
            };
            const views = {
                clock: document.getElementById('clock-view'),
                pomodoro: document.getElementById('pomodoro-view'),
                alarm: document.getElementById('alarm-view'),
                settings: document.getElementById('settings-view')
            };
            
            // --- Clock View Elements ---
            const clockDigits = {
                hrTens: document.getElementById('clock-hr-tens'),
                hrOnes: document.getElementById('clock-hr-ones'),
                minTens: document.getElementById('clock-min-tens'),
                minOnes: document.getElementById('clock-min-ones'),
                secTens: document.getElementById('clock-sec-tens'),
                secOnes: document.getElementById('clock-sec-ones')
            };
            
            // --- Pomodoro View Elements ---
            const pomodoroDigits = {
                minTens: document.getElementById('pomo-min-tens'),
                minOnes: document.getElementById('pomo-min-ones'),
                secTens: document.getElementById('pomo-sec-tens'),
                secOnes: document.getElementById('pomo-sec-ones')
            };
            const pomoTitle = document.getElementById('pomodoro-title');
            const pomoStatus = document.getElementById('pomodoro-status');
            const pomoSettings = document.getElementById('pomodoro-settings');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const continueBtn = document.getElementById('continue-btn');
            const focusModeBtn = document.getElementById('focus-mode-btn'); // New element reference
            const focusInput = document.getElementById('focus-time-input');
            const breakInput = document.getElementById('break-time-input');

            // --- Theme Elements ---
            const fontSelect = document.getElementById('font-select');
            const digitFontSelect = document.getElementById('digit-font-select'); 
            const colorPicker = document.getElementById('accent-color-picker');
            const themePresetBtns = document.querySelectorAll('.theme-preset-btn');
            const appTitle = document.getElementById('app-title');
            
            // --- Alarm View Elements ---
            const alarmTimeInput = document.getElementById('alarm-time-input');
            const setAlarmBtn = document.getElementById('set-alarm-btn');
            const clearAlarmBtn = document.getElementById('clear-alarm-btn');
            const alarmStopControls = document.getElementById('alarm-stop-controls');
            const stopAlarmBtn = document.getElementById('stop-alarm-btn');
            const alarmStatusMsg = document.getElementById('alarm-status-message');


            // ==============================================
            // === SPLIT-FLAP CORE LOGIC ===
            // ==============================================

            /**
             * Creates the HTML structure for a single flip digit.
             */
            function createDigitHTML(initialValue = 0) {
                return `
                    <div class="digit-half static-top">
                        <div class="digit-half-content static-top-content">${initialValue}</div>
                    </div>
                    <div class="digit-half static-bottom">
                        <div class="digit-half-content static-bottom-content">${initialValue}</div>
                    </div>
                    <div class="flap">
                        <div class="flap-face flap-front">
                            <div class="flap-face-content flap-front-content">${initialValue}</div>
                        </div>
                        <div class="flap-face flap-back">
                            <div class="flap-face-content flap-back-content">${initialValue}</div>
                        </div>
                    </div>
                `;
            }

            /**
             * Performs the flip animation on a single digit container.
             */
            function performFlip(digitContainer, newValue) {
                if (!digitContainer) return;
                
                const staticTop = digitContainer.querySelector('.static-top-content');
                const staticBottom = digitContainer.querySelector('.static-bottom-content');
                const flapFront = digitContainer.querySelector('.flap-front-content');
                const flapBack = digitContainer.querySelector('.flap-back-content');
                const currentValue = staticBottom.textContent;

                if (currentValue === String(newValue)) {
                    return;
                }

                staticTop.textContent = newValue;
                flapBack.textContent = newValue;
                digitContainer.classList.add('flipping');

                setTimeout(() => {
                    staticBottom.textContent = newValue;
                    flapFront.textContent = newValue;
                    digitContainer.classList.remove('flipping');
                }, 600);
            }


            // ==============================================
            // === HELPER FUNCTIONS ===
            // ==============================================
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return {
                    minTens: Math.floor(mins / 10),
                    minOnes: mins % 10,
                    secTens: Math.floor(secs / 10),
                    secOnes: secs % 10
                };
            }
            
            function formatClockTime(date) {
                const h = date.getHours();
                const m = date.getMinutes();
                const s = date.getSeconds();
                return {
                    hrTens: Math.floor(h / 10),
                    hrOnes: h % 10,
                    minTens: Math.floor(m / 10),
                    minOnes: m % 10,
                    secTens: Math.floor(s / 10),
                    secOnes: s % 10
                };
            }
            
            function playAlarm(loop = false) {
                audio.loop = loop;
                audio.currentTime = 0;
                audio.play().catch(e => console.error("Audio play failed:", e));
            }

            function stopAlarm() {
                audio.pause();
                audio.currentTime = 0;
            }
            
            // ==============================================
            // === THEME LOGIC ===
            // ==============================================

            function applyTheme() {
                // 1. Apply body font via style attribute
                const fontName = globalState.theme.font;
                let fontFamily = 'Rajdhani, sans-serif';
                if (fontName === 'Inter') {
                    fontFamily = 'Inter, sans-serif';
                } else if (fontName === 'Monospace') {
                    fontFamily = "'Courier New', monospace";
                }
                body.style.fontFamily = fontFamily;
                
                // 2. Apply digit font via CSS variable
                const digitFontName = globalState.theme.digitFont;
                let digitFontFamily = 'Orbitron, sans-serif';
                if (digitFontName === 'Roboto Mono') {
                    digitFontFamily = "'Roboto Mono', monospace";
                } else if (digitFontName === 'Major Mono Display') {
                    digitFontFamily = "'Major Mono Display', monospace";
                }
                root.style.setProperty('--digit-font-family', digitFontFamily);


                // 3. Apply primary color via CSS variable
                root.style.setProperty('--primary-color', globalState.theme.primaryColor);
                
                // 4. Re-apply active nav class to update border/background color
                switchView(globalState.activeView, false); 
            }
            
            function handleFontChange(e) {
                globalState.theme.font = e.target.value;
                applyTheme();
            }

            function handleDigitFontChange(e) {
                globalState.theme.digitFont = e.target.value;
                applyTheme();
            }

            function handleColorChange(e) {
                globalState.theme.primaryColor = e.target.value;
                applyTheme();
            }

            function handlePresetClick(e) {
                const color = e.currentTarget.getAttribute('data-color');
                globalState.theme.primaryColor = color;
                colorPicker.value = color; // Sync color picker
                applyTheme();
            }
            
            // ==============================================
            // === VIEW SWITCHING LOGIC ===
            // ==============================================

            function switchView(viewName, updateHistory = true) {
                globalState.activeView = viewName;
                Object.values(views).forEach(view => view.setAttribute('hidden', true));
                
                // Remove active classes from all nav buttons
                Object.values(navButtons).forEach(btn => {
                    btn.classList.remove('nav-button-active', 'border-primary-color', 'border');
                });
                
                if (views[viewName]) {
                    views[viewName].removeAttribute('hidden');
                }
                
                // Apply active class using dynamic primary color
                if (navButtons[viewName]) {
                    navButtons[viewName].classList.add('nav-button-active');
                }
                
                // Extra logic for Clock view start/stop
                if (viewName === 'clock') {
                    startClock();
                } else if (globalState.clock.intervalId) {
                    clearInterval(globalState.clock.intervalId);
                    globalState.clock.intervalId = null;
                }
            }


            // ==============================================
            // === CLOCK LOGIC ===
            // ==============================================
            
            function initializeClockDigits() {
                const now = new Date();
                const time = formatClockTime(now);
                
                clockDigits.hrTens.innerHTML = createDigitHTML(time.hrTens);
                clockDigits.hrOnes.innerHTML = createDigitHTML(time.hrOnes);
                clockDigits.minTens.innerHTML = createDigitHTML(time.minTens);
                clockDigits.minOnes.innerHTML = createDigitHTML(time.minOnes);
                clockDigits.secTens.innerHTML = createDigitHTML(time.secTens);
                clockDigits.secOnes.innerHTML = createDigitHTML(time.secOnes);
            }
            
            function updateClockDisplay() {
                const now = new Date();
                const time = formatClockTime(now);
                
                performFlip(clockDigits.hrTens, time.hrTens);
                performFlip(clockDigits.hrOnes, time.hrOnes);
                performFlip(clockDigits.minTens, time.minTens);
                performFlip(clockDigits.minOnes, time.minOnes);
                performFlip(clockDigits.secTens, time.secTens);
                performFlip(clockDigits.secOnes, time.secOnes);
            }

            function startClock() {
                if (globalState.clock.intervalId) {
                    clearInterval(globalState.clock.intervalId);
                }
                updateClockDisplay();
                globalState.clock.intervalId = setInterval(updateClockDisplay, 1000);
            }


            // ==============================================
            // === POMODORO LOGIC ===
            // ==============================================
            
            function initializePomodoroDigits() {
                const time = formatTime(globalState.pomodoro.timeLeft);
                pomodoroDigits.minTens.innerHTML = createDigitHTML(time.minTens);
                pomodoroDigits.minOnes.innerHTML = createDigitHTML(time.minOnes);
                pomodoroDigits.secTens.innerHTML = createDigitHTML(time.secTens);
                pomodoroDigits.secOnes.innerHTML = createDigitHTML(time.secOnes);
            }
            
            function updatePomodoroDisplay() {
                const time = formatTime(globalState.pomodoro.timeLeft);
                performFlip(pomodoroDigits.minTens, time.minTens);
                performFlip(pomodoroDigits.minOnes, time.minOnes);
                performFlip(pomodoroDigits.secTens, time.secTens);
                performFlip(pomodoroDigits.secOnes, time.secOnes);
            }
            
            function pomodoroTick() {
                globalState.pomodoro.timeLeft -= 1;
                updatePomodoroDisplay();
                
                if (globalState.pomodoro.timeLeft <= 0) {
                    clearInterval(globalState.pomodoro.intervalId);
                    globalState.pomodoro.intervalId = null;
                    globalState.pomodoro.isRunning = false;
                    globalState.pomodoro.isAlarmPlaying = true;
                    
                    playAlarm(true);
                    
                    // Show "Continue" button, hide Start/Reset/Focus
                    startPauseBtn.setAttribute('hidden', true);
                    resetBtn.setAttribute('hidden', true);
                    focusModeBtn.setAttribute('hidden', true); // Hide Focus button
                    continueBtn.removeAttribute('hidden');
                    pomoSettings.setAttribute('hidden', true);
                    
                    pomoStatus.textContent = globalState.pomodoro.isBreak ? "Break's Over!" : "Time for a Break!";
                }
            }
            
            function togglePomodoro() {
                if (globalState.pomodoro.isAlarmPlaying) return;

                globalState.pomodoro.isRunning = !globalState.pomodoro.isRunning;
                
                if (globalState.pomodoro.isRunning) {
                    startPauseBtn.textContent = "Pause";
                    pomoSettings.setAttribute('hidden', true);
                    
                    if (!globalState.pomodoro.intervalId) {
                        if (globalState.pomodoro.timeLeft <= 0) {
                             const newTime = globalState.pomodoro.isBreak ? globalState.pomodoro.breakTime : globalState.pomodoro.focusTime;
                             globalState.pomodoro.timeLeft = newTime * 60;
                             updatePomodoroDisplay();
                        }
                        globalState.pomodoro.intervalId = setInterval(pomodoroTick, 1000);
                    }
                } else {
                    startPauseBtn.textContent = "Start";
                    pomoSettings.removeAttribute('hidden');
                    
                    if (globalState.pomodoro.intervalId) {
                        clearInterval(globalState.pomodoro.intervalId);
                        globalState.pomodoro.intervalId = null;
                    }
                }
            }
            
            function resetPomodoro() {
                if (globalState.pomodoro.intervalId) {
                    clearInterval(globalState.pomodoro.intervalId);
                    globalState.pomodoro.intervalId = null;
                }
                
                stopAlarm();
                
                globalState.pomodoro.isRunning = false;
                globalState.pomodoro.isAlarmPlaying = false;
                globalState.pomodoro.isBreak = false;
                globalState.pomodoro.timeLeft = globalState.pomodoro.focusTime * 60;
                
                updatePomodoroDisplay();
                
                startPauseBtn.textContent = "Start";
                pomoStatus.textContent = "Focus Time";
                
                // Ensure the correct buttons are shown/hidden
                startPauseBtn.removeAttribute('hidden');
                resetBtn.removeAttribute('hidden');
                focusModeBtn.removeAttribute('hidden'); // Show Focus button on reset
                continueBtn.setAttribute('hidden', true);
                
                pomoSettings.removeAttribute('hidden');
            }
            
            function continuePomodoro() {
                stopAlarm();
                
                globalState.pomodoro.isAlarmPlaying = false;
                globalState.pomodoro.isBreak = !globalState.pomodoro.isBreak;
                
                const newTime = globalState.pomodoro.isBreak ? globalState.pomodoro.breakTime : globalState.pomodoro.focusTime;
                globalState.pomodoro.timeLeft = newTime * 60;
                
                pomoStatus.textContent = globalState.pomodoro.isBreak ? "Break Time" : "Focus Time";
                
                updatePomodoroDisplay();
                
                // Hide "Continue", show main controls
                startPauseBtn.removeAttribute('hidden');
                resetBtn.removeAttribute('hidden');
                focusModeBtn.removeAttribute('hidden'); // Show Focus button
                continueBtn.setAttribute('hidden', true);
                
                // Automatically start the next session
                togglePomodoro(); 
            }
            
            // ==============================================
            // === FOCUS MODE LOGIC ===
            // ==============================================

            function toggleFocusMode() {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    // Request fullscreen on the entire document element
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                }
            }

            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                
                if (isFullscreen) {
                    body.classList.add('fullscreen-focus');
                } else {
                    body.classList.remove('fullscreen-focus');
                }
                
                // Update the button text only when the pomodoro view is active
                if (globalState.activeView === 'pomodoro') {
                    focusModeBtn.textContent = isFullscreen ? 'Exit Focus' : 'Focus Mode';
                    
                    // The focus button itself must not be hidden in focus mode, 
                    // otherwise the user has no way to exit without the escape key.
                    // Instead, we will hide all *other* controls.
                    if (isFullscreen) {
                        startPauseBtn.classList.add('focus-mode-hidden');
                        resetBtn.classList.add('focus-mode-hidden');
                        continueBtn.classList.add('focus-mode-hidden');
                        // Make the focus button visible and primary to serve as the exit button
                        focusModeBtn.classList.remove('btn-secondary');
                        focusModeBtn.classList.add('btn-primary');
                    } else {
                        startPauseBtn.classList.remove('focus-mode-hidden');
                        resetBtn.classList.remove('focus-mode-hidden');
                        continueBtn.classList.remove('focus-mode-hidden');
                        // Restore the focus button to its secondary state (it only acts as the primary exit button when active)
                        focusModeBtn.classList.add('btn-secondary');
                        focusModeBtn.classList.remove('btn-primary');
                    }
                }
            });

            // ==============================================
            // === ALARM LOGIC ===
            // ==============================================
            
            function checkAlarm() {
                if (!globalState.alarm.setTime || globalState.alarm.isAlarmPlaying) {
                    return;
                }
                
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                if (currentTime === globalState.alarm.setTime) {
                    console.log("ALARM TRIGGERED!");
                    globalState.alarm.isAlarmPlaying = true;
                    globalState.alarm.setTime = null;
                    alarmStatusMsg.textContent = "Alarm!";
                    
                    playAlarm(true);
                    
                    alarmStopControls.removeAttribute('hidden');
                }
            }
            
            function setAlarm() {
                const timeValue = alarmTimeInput.value;
                if (!timeValue) {
                    alarmStatusMsg.textContent = "Please select a valid time.";
                    return;
                }
                
                globalState.alarm.setTime = timeValue;
                alarmStatusMsg.textContent = `Alarm set for ${timeValue}`;
                
                if (!globalState.alarm.checkIntervalId) {
                    globalState.alarm.checkIntervalId = setInterval(checkAlarm, 5000);
                }
            }
            
            function clearAlarm() {
                globalState.alarm.setTime = null;
                alarmStatusMsg.textContent = "Alarm cleared.";
                
                if (globalState.alarm.isAlarmPlaying) {
                    stopGeneralAlarm();
                }
            }
            
            function stopGeneralAlarm() {
                stopAlarm();
                globalState.alarm.isAlarmPlaying = false;
                alarmStopControls.setAttribute('hidden', true);
                alarmStatusMsg.textContent = "Alarm stopped.";
            }

            // ==============================================
            // === INITIALIZATION & EVENT LISTENERS ===
            // ==============================================
            
            // --- Navigation Listeners ---
            navButtons.clock.addEventListener('click', () => switchView('clock'));
            navButtons.pomodoro.addEventListener('click', () => switchView('pomodoro'));
            navButtons.alarm.addEventListener('click', () => switchView('alarm'));
            navButtons.settings.addEventListener('click', () => switchView('settings')); 
            
            // --- Pomodoro Listeners ---
            startPauseBtn.addEventListener('click', togglePomodoro);
            resetBtn.addEventListener('click', resetPomodoro);
            continueBtn.addEventListener('click', continuePomodoro);
            focusModeBtn.addEventListener('click', toggleFocusMode); // Focus Mode Listener
            
            focusInput.addEventListener('change', (e) => {
                const val = Math.max(1, parseInt(e.target.value) || 1);
                globalState.pomodoro.focusTime = val;
                if (!globalState.pomodoro.isRunning && !globalState.pomodoro.isBreak) {
                    globalState.pomodoro.timeLeft = val * 60;
                    updatePomodoroDisplay();
                }
            });
            
            breakInput.addEventListener('change', (e) => {
                const val = Math.max(1, parseInt(e.target.value) || 1);
                globalState.pomodoro.breakTime = val;
                if (!globalState.pomodoro.isRunning && globalState.pomodoro.isBreak) {
                    globalState.pomodoro.timeLeft = val * 60;
                    updatePomodoroDisplay();
                }
            });

            // --- Theme Listeners ---
            fontSelect.addEventListener('change', handleFontChange);
            digitFontSelect.addEventListener('change', handleDigitFontChange); 
            colorPicker.addEventListener('input', handleColorChange);
            themePresetBtns.forEach(btn => btn.addEventListener('click', handlePresetClick));
            
            // --- Alarm Listeners ---
            setAlarmBtn.addEventListener('click', setAlarm);
            clearAlarmBtn.addEventListener('click', clearAlarm);
            stopAlarmBtn.addEventListener('click', stopGeneralAlarm);

            function init() {
                // Initialize state values for inputs/selectors
                fontSelect.value = globalState.theme.font;
                digitFontSelect.value = globalState.theme.digitFont;
                colorPicker.value = globalState.theme.primaryColor;
                
                // Apply initial theme settings
                applyTheme(); 

                initializeClockDigits();
                initializePomodoroDigits();
                startClock();
                globalState.alarm.checkIntervalId = setInterval(checkAlarm, 5000);
                switchView('pomodoro');
            }
            
            init();
        });
    </script>
</body>
</html>
